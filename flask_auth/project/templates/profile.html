{% extends "base.html" %}

{% block content %}

<!-- Flash messages -->
{% with messages = get_flashed_messages(category_filter=["bio","follow"]) %}
  {% if messages %}
    <div class="flash-messages" style="margin-bottom: 1rem;">
      {% for message in messages %}
        <div class="alert">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %} 
{% endwith %}

<!-- Flash messages généraux (success / error) -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="notification {% if category == 'success' %}is-success{% else %}is-danger{% endif %}"
           style="border-radius: 18px;">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- Profil Card -->
<div class="profile-card">
    <div class="profile-header">
        <h1 style="font-size: 2rem; font-weight: 700;">@{{ user.name | replace(' ','') }}</h1>

        <div style="display:flex; gap:0.5rem;">
            {% if is_own_profile %}
                <button id="edit-bio-btn" class="white-btn profile-btn">Edit Bio</button>
                <a href="{{ url_for('main.tweet') }}" class="white-btn profile-btn">Post</a>
            {% else %}
                <form action="{{ url_for('main.unfollow', user_id=user.id) if current_user.is_following(user) else url_for('main.follow', user_id=user.id) }}" method="POST">
                    <button type="submit" class="white-btn profile-btn">
                        {% if current_user.is_following(user) %}Unfollow{% else %}Follow{% endif %}
                    </button>
                </form>
            {% endif %}

        <div style="display: flex; gap: 0.5rem; flex-wrap: nowrap;">
            <button id="edit-bio-btn" class="white-btn profile-btn">
                Edit Bio
            </button>
            <a href="{{ url_for('main.tweet') }}" class="white-btn profile-btn">
                Post
            </a>
            <a href="{{ url_for('auth.password_page') }}" class="button profile-btn white-btn">
                Change Password
            </a>
        </div>
    </div>

    <!-- Bio -->
    <p id="bio-text" class="bio-text">{{ user.bio or "This user hasn’t written a bio yet." }}</p>

    {% if is_own_profile %}
    <form id="edit-bio-form" class="bio-form" action="{{ url_for('main.edit_bio') }}" method="POST" style="display:none;">
        <textarea name="bio" rows="3" maxlength="300">{{ user.bio or '' }}</textarea>
        <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
            <button type="submit" class="white-btn profile-btn">Save</button>
            <button type="button" id="cancel-bio-btn" class="cancel-btn profile-btn">Cancel</button>
        </div>
    </form>
    {% endif %}

    <!-- Stats -->
    <div style="display:flex; gap:1.5rem; margin-top:1rem;">
        <div><strong>{{ following_count }}</strong> Following</div>
        <div><strong>{{ followers_count }}</strong> Followers</div>
    </div>
</div>

<!-- Tweets -->
<div class="tweets-list">
    {% if tweets %}
        {% for tweet in tweets %}
        <div class="tweet-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                <strong>@{{ tweet.user.name }}</strong>
                <small>{{ tweet.timestamp.strftime('%d/%m/%Y %H:%M') }}</small>
            </div>
            <p>{{ tweet.content }}</p>
            {% if is_own_profile and tweet.user_id == current_user.id %}
            <form action="{{ url_for('main.delete_tweet', tweet_id=tweet.id) }}" method="POST" style="margin-top:0.5rem;">
                <button type="submit" class="cancel-btn profile-btn" style="background:#e74c3c;color:white;">Delete</button>
            </form>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
        <p style="font-style:italic; color:gray;">No tweets yet.</p>
    {% endif %}
</div>

<!-- JS pour edit bio -->
<script>
const editBtn = document.getElementById('edit-bio-btn');
const cancelBtn = document.getElementById('cancel-bio-btn');
const form = document.getElementById('edit-bio-form');
const bioText = document.getElementById('bio-text');

if(editBtn && cancelBtn && form && bioText){
    editBtn.addEventListener('click', ()=>{
        form.style.display = 'block';
        editBtn.style.display = 'none';
        bioText.style.display = 'none';
    });
    cancelBtn.addEventListener('click', ()=>{
        form.style.display = 'none';
        editBtn.style.display = 'inline-flex';
        bioText.style.display = 'block';
    });
}

// Faire disparaître les flash messages après 3s
document.querySelectorAll('.flash-messages .alert').forEach(msg=>{
    setTimeout(()=>{ msg.style.opacity=0; setTimeout(()=>msg.remove(),500); }, 3000);
});
</script>

{% endblock %}
